{"ast":null,"code":"/*! @azure/msal-common v13.3.1 2023-10-27 */\n'use strict';\n\nimport { __awaiter, __generator, __assign } from '../_virtual/_tslib.js';\nimport { TimeUtils } from '../utils/TimeUtils.js';\nimport { UrlString } from '../url/UrlString.js';\nimport { PerformanceEvents } from '../telemetry/performance/PerformanceEvent.js';\n/*\r\n * Copyright (c) Microsoft Corporation. All rights reserved.\r\n * Licensed under the MIT License.\r\n */\n\nvar KeyLocation;\n\n(function (KeyLocation) {\n  KeyLocation[\"SW\"] = \"sw\";\n  KeyLocation[\"UHW\"] = \"uhw\";\n})(KeyLocation || (KeyLocation = {}));\n\nvar PopTokenGenerator =\n/** @class */\nfunction () {\n  function PopTokenGenerator(cryptoUtils, performanceClient) {\n    this.cryptoUtils = cryptoUtils;\n    this.performanceClient = performanceClient;\n  }\n  /**\r\n   * Generates the req_cnf validated at the RP in the POP protocol for SHR parameters\r\n   * and returns an object containing the keyid, the full req_cnf string and the req_cnf string hash\r\n   * @param request\r\n   * @returns\r\n   */\n\n\n  PopTokenGenerator.prototype.generateCnf = function (request) {\n    var _a, _b;\n\n    return __awaiter(this, void 0, void 0, function () {\n      var reqCnf, reqCnfString, _c;\n\n      return __generator(this, function (_d) {\n        switch (_d.label) {\n          case 0:\n            (_a = this.performanceClient) === null || _a === void 0 ? void 0 : _a.addQueueMeasurement(PerformanceEvents.PopTokenGenerateCnf, request.correlationId);\n            (_b = this.performanceClient) === null || _b === void 0 ? void 0 : _b.setPreQueueTime(PerformanceEvents.PopTokenGenerateKid, request.correlationId);\n            return [4\n            /*yield*/\n            , this.generateKid(request)];\n\n          case 1:\n            reqCnf = _d.sent();\n            reqCnfString = this.cryptoUtils.base64Encode(JSON.stringify(reqCnf));\n            _c = {\n              kid: reqCnf.kid,\n              reqCnfString: reqCnfString\n            };\n            return [4\n            /*yield*/\n            , this.cryptoUtils.hashString(reqCnfString)];\n\n          case 2:\n            return [2\n            /*return*/\n            , (_c.reqCnfHash = _d.sent(), _c)];\n        }\n      });\n    });\n  };\n  /**\r\n   * Generates key_id for a SHR token request\r\n   * @param request\r\n   * @returns\r\n   */\n\n\n  PopTokenGenerator.prototype.generateKid = function (request) {\n    var _a;\n\n    return __awaiter(this, void 0, void 0, function () {\n      var kidThumbprint;\n      return __generator(this, function (_b) {\n        switch (_b.label) {\n          case 0:\n            (_a = this.performanceClient) === null || _a === void 0 ? void 0 : _a.addQueueMeasurement(PerformanceEvents.PopTokenGenerateKid, request.correlationId);\n            return [4\n            /*yield*/\n            , this.cryptoUtils.getPublicKeyThumbprint(request)];\n\n          case 1:\n            kidThumbprint = _b.sent();\n            return [2\n            /*return*/\n            , {\n              kid: kidThumbprint,\n              xms_ksl: KeyLocation.SW\n            }];\n        }\n      });\n    });\n  };\n  /**\r\n   * Signs the POP access_token with the local generated key-pair\r\n   * @param accessToken\r\n   * @param request\r\n   * @returns\r\n   */\n\n\n  PopTokenGenerator.prototype.signPopToken = function (accessToken, keyId, request) {\n    return __awaiter(this, void 0, void 0, function () {\n      return __generator(this, function (_a) {\n        return [2\n        /*return*/\n        , this.signPayload(accessToken, keyId, request)];\n      });\n    });\n  };\n  /**\r\n   * Utility function to generate the signed JWT for an access_token\r\n   * @param payload\r\n   * @param kid\r\n   * @param request\r\n   * @param claims\r\n   * @returns\r\n   */\n\n\n  PopTokenGenerator.prototype.signPayload = function (payload, keyId, request, claims) {\n    return __awaiter(this, void 0, void 0, function () {\n      var resourceRequestMethod, resourceRequestUri, shrClaims, shrNonce, resourceUrlString, resourceUrlComponents;\n      return __generator(this, function (_a) {\n        switch (_a.label) {\n          case 0:\n            resourceRequestMethod = request.resourceRequestMethod, resourceRequestUri = request.resourceRequestUri, shrClaims = request.shrClaims, shrNonce = request.shrNonce;\n            resourceUrlString = resourceRequestUri ? new UrlString(resourceRequestUri) : undefined;\n            resourceUrlComponents = resourceUrlString === null || resourceUrlString === void 0 ? void 0 : resourceUrlString.getUrlComponents();\n            return [4\n            /*yield*/\n            , this.cryptoUtils.signJwt(__assign({\n              at: payload,\n              ts: TimeUtils.nowSeconds(),\n              m: resourceRequestMethod === null || resourceRequestMethod === void 0 ? void 0 : resourceRequestMethod.toUpperCase(),\n              u: resourceUrlComponents === null || resourceUrlComponents === void 0 ? void 0 : resourceUrlComponents.HostNameAndPort,\n              nonce: shrNonce || this.cryptoUtils.createNewGuid(),\n              p: resourceUrlComponents === null || resourceUrlComponents === void 0 ? void 0 : resourceUrlComponents.AbsolutePath,\n              q: (resourceUrlComponents === null || resourceUrlComponents === void 0 ? void 0 : resourceUrlComponents.QueryString) ? [[], resourceUrlComponents.QueryString] : undefined,\n              client_claims: shrClaims || undefined\n            }, claims), keyId, request.correlationId)];\n\n          case 1:\n            return [2\n            /*return*/\n            , _a.sent()];\n        }\n      });\n    });\n  };\n\n  return PopTokenGenerator;\n}();\n\nexport { PopTokenGenerator };","map":{"version":3,"names":["__awaiter","__generator","__assign","TimeUtils","UrlString","PerformanceEvents","KeyLocation","PopTokenGenerator","cryptoUtils","performanceClient","prototype","generateCnf","request","_a","_b","reqCnf","reqCnfString","_c","_d","label","addQueueMeasurement","PopTokenGenerateCnf","correlationId","setPreQueueTime","PopTokenGenerateKid","generateKid","sent","base64Encode","JSON","stringify","kid","hashString","reqCnfHash","kidThumbprint","getPublicKeyThumbprint","xms_ksl","SW","signPopToken","accessToken","keyId","signPayload","payload","claims","resourceRequestMethod","resourceRequestUri","shrClaims","shrNonce","resourceUrlString","resourceUrlComponents","undefined","getUrlComponents","signJwt","at","ts","nowSeconds","m","toUpperCase","u","HostNameAndPort","nonce","createNewGuid","p","AbsolutePath","q","QueryString","client_claims"],"sources":["F:/Bovis/Front/bovis-dev/node_modules/@azure/msal-common/dist/crypto/PopTokenGenerator.js"],"sourcesContent":["/*! @azure/msal-common v13.3.1 2023-10-27 */\n'use strict';\nimport { __awaiter, __generator, __assign } from '../_virtual/_tslib.js';\nimport { TimeUtils } from '../utils/TimeUtils.js';\nimport { UrlString } from '../url/UrlString.js';\nimport { PerformanceEvents } from '../telemetry/performance/PerformanceEvent.js';\n\n/*\r\n * Copyright (c) Microsoft Corporation. All rights reserved.\r\n * Licensed under the MIT License.\r\n */\r\nvar KeyLocation;\r\n(function (KeyLocation) {\r\n    KeyLocation[\"SW\"] = \"sw\";\r\n    KeyLocation[\"UHW\"] = \"uhw\";\r\n})(KeyLocation || (KeyLocation = {}));\r\nvar PopTokenGenerator = /** @class */ (function () {\r\n    function PopTokenGenerator(cryptoUtils, performanceClient) {\r\n        this.cryptoUtils = cryptoUtils;\r\n        this.performanceClient = performanceClient;\r\n    }\r\n    /**\r\n     * Generates the req_cnf validated at the RP in the POP protocol for SHR parameters\r\n     * and returns an object containing the keyid, the full req_cnf string and the req_cnf string hash\r\n     * @param request\r\n     * @returns\r\n     */\r\n    PopTokenGenerator.prototype.generateCnf = function (request) {\r\n        var _a, _b;\r\n        return __awaiter(this, void 0, void 0, function () {\r\n            var reqCnf, reqCnfString, _c;\r\n            return __generator(this, function (_d) {\r\n                switch (_d.label) {\r\n                    case 0:\r\n                        (_a = this.performanceClient) === null || _a === void 0 ? void 0 : _a.addQueueMeasurement(PerformanceEvents.PopTokenGenerateCnf, request.correlationId);\r\n                        (_b = this.performanceClient) === null || _b === void 0 ? void 0 : _b.setPreQueueTime(PerformanceEvents.PopTokenGenerateKid, request.correlationId);\r\n                        return [4 /*yield*/, this.generateKid(request)];\r\n                    case 1:\r\n                        reqCnf = _d.sent();\r\n                        reqCnfString = this.cryptoUtils.base64Encode(JSON.stringify(reqCnf));\r\n                        _c = {\r\n                            kid: reqCnf.kid,\r\n                            reqCnfString: reqCnfString\r\n                        };\r\n                        return [4 /*yield*/, this.cryptoUtils.hashString(reqCnfString)];\r\n                    case 2: return [2 /*return*/, (_c.reqCnfHash = _d.sent(),\r\n                            _c)];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    /**\r\n     * Generates key_id for a SHR token request\r\n     * @param request\r\n     * @returns\r\n     */\r\n    PopTokenGenerator.prototype.generateKid = function (request) {\r\n        var _a;\r\n        return __awaiter(this, void 0, void 0, function () {\r\n            var kidThumbprint;\r\n            return __generator(this, function (_b) {\r\n                switch (_b.label) {\r\n                    case 0:\r\n                        (_a = this.performanceClient) === null || _a === void 0 ? void 0 : _a.addQueueMeasurement(PerformanceEvents.PopTokenGenerateKid, request.correlationId);\r\n                        return [4 /*yield*/, this.cryptoUtils.getPublicKeyThumbprint(request)];\r\n                    case 1:\r\n                        kidThumbprint = _b.sent();\r\n                        return [2 /*return*/, {\r\n                                kid: kidThumbprint,\r\n                                xms_ksl: KeyLocation.SW\r\n                            }];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    /**\r\n     * Signs the POP access_token with the local generated key-pair\r\n     * @param accessToken\r\n     * @param request\r\n     * @returns\r\n     */\r\n    PopTokenGenerator.prototype.signPopToken = function (accessToken, keyId, request) {\r\n        return __awaiter(this, void 0, void 0, function () {\r\n            return __generator(this, function (_a) {\r\n                return [2 /*return*/, this.signPayload(accessToken, keyId, request)];\r\n            });\r\n        });\r\n    };\r\n    /**\r\n     * Utility function to generate the signed JWT for an access_token\r\n     * @param payload\r\n     * @param kid\r\n     * @param request\r\n     * @param claims\r\n     * @returns\r\n     */\r\n    PopTokenGenerator.prototype.signPayload = function (payload, keyId, request, claims) {\r\n        return __awaiter(this, void 0, void 0, function () {\r\n            var resourceRequestMethod, resourceRequestUri, shrClaims, shrNonce, resourceUrlString, resourceUrlComponents;\r\n            return __generator(this, function (_a) {\r\n                switch (_a.label) {\r\n                    case 0:\r\n                        resourceRequestMethod = request.resourceRequestMethod, resourceRequestUri = request.resourceRequestUri, shrClaims = request.shrClaims, shrNonce = request.shrNonce;\r\n                        resourceUrlString = (resourceRequestUri) ? new UrlString(resourceRequestUri) : undefined;\r\n                        resourceUrlComponents = resourceUrlString === null || resourceUrlString === void 0 ? void 0 : resourceUrlString.getUrlComponents();\r\n                        return [4 /*yield*/, this.cryptoUtils.signJwt(__assign({ at: payload, ts: TimeUtils.nowSeconds(), m: resourceRequestMethod === null || resourceRequestMethod === void 0 ? void 0 : resourceRequestMethod.toUpperCase(), u: resourceUrlComponents === null || resourceUrlComponents === void 0 ? void 0 : resourceUrlComponents.HostNameAndPort, nonce: shrNonce || this.cryptoUtils.createNewGuid(), p: resourceUrlComponents === null || resourceUrlComponents === void 0 ? void 0 : resourceUrlComponents.AbsolutePath, q: (resourceUrlComponents === null || resourceUrlComponents === void 0 ? void 0 : resourceUrlComponents.QueryString) ? [[], resourceUrlComponents.QueryString] : undefined, client_claims: shrClaims || undefined }, claims), keyId, request.correlationId)];\r\n                    case 1: return [2 /*return*/, _a.sent()];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    return PopTokenGenerator;\r\n}());\n\nexport { PopTokenGenerator };\n"],"mappings":"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"},"metadata":{},"sourceType":"module"}