
<p-toast></p-toast>

<div class="d-flex gap-2 mb-2 justify-content-between">
  <h1>Etapas</h1>
  <a
    title="Agregar etapa" 
    pButton 
    pRipple 
    icon="pi pi-plus"
    class="p-button-rounded p-button-info p-mr-2"
    style="text-decoration: none;"
    (click)="agregarEtapa()"
  ></a>
</div>

<!-- <p>Duración del proyecto en meses: <strong>{{duracionMeses}}</strong></p> -->

<!-- <form [formGroup]="etapaForm" (ngSubmit)="agregarEtapa()">
  <div class="grid mb-2">
    <div class="col">
      <div class="flex justify-content-between gap-3 p-fluid">
        <div class="flex-auto">
          <input type="text" pInputText formControlName="etapa" class="form-control" placeholder="Escribe el nombre de la etapa..."/>
        </div>
        <button class="btn btn-info" type="submit" [disabled]="!etapaForm.valid">Agregar</button>
      </div>
    </div>
  </div>
</form> -->

<div class="text-center" *ngIf="!proyectoSeleccionado; else cargandoView">
  <p>Seleccione un proyecto y presione el botón <strong>Editar</strong>.</p>
</div>

<ng-template #cargandoView>
  <div class="text-center" *ngIf="cargando">
    <p-progressSpinner styleClass="w-5rem h-5rem custom-spinner"></p-progressSpinner>
    <p>Cargando etapas...</p>
    <p><strong>Un momento.</strong></p>
  </div>
</ng-template>

<div class="text-center" *ngIf="!cargando && etapas.controls.length == 0; else tablaEtapas">
  <p>Agregue al menos una etapa para comenzar.</p>
</div>

<ng-template #tablaEtapas [formGroup]="form">
    <ng-container formArrayName="etapas">
      <p-accordion [activeIndex]="i" [formGroupName]="i" *ngFor="let etapa of etapas.controls; let i = index" (onOpen)="abre()">
        <p-accordionTab>
          <ng-template pTemplate="header">
            <div class="d-flex justify-content-between align-items-center w-100">
              <div class="title">
                <i class="pi pi-calendar mr-2 vertical-align-middle"></i>
                <span class="vertical-align-middle">{{obtenerNombreFase(etapa.value)}}</span>
              </div>
              <div class="options d-flex gap-2">
                <button 
                  title="Agregar empleado" 
                  type="button" 
                  class="btn btn-success" 
                  (click)="modificarEmpleado($event, etapa.value, null, i, null)"
                >
                  <i class="pi pi-user-plus vertical-align-middle"></i>
                </button>
                <button
                  title="Eliminar etapa" 
                  type="button"
                  class="btn btn-danger"
                  (click)="eliminarEtapa($event, etapa.value, i)"
                >
                  <i class="pi pi-trash vertical-align-middle"></i>
                </button>
              </div>
            </div>
          </ng-template>
          <ng-template pTemplate="content">
            <p-table [value]="empleados(i).controls" [scrollable]="true" scrollHeight="400px">
              <ng-template pTemplate="header">
                  <tr>
                      <th width="100px">Opciones</th>
                      <th width="100px">No. Empleado</th>
                      <th>Nombre</th>
                      <th *ngFor="let mesRegistro of etapa.value.meses">
                        {{mesRegistro.desc | uppercase}}
                      </th>
                  </tr>
              </ng-template>
              <ng-template pTemplate="body" let-empleado let-iEmpleado="rowIndex">
                  <tr>
                    <td>
                      <div class="d-flex gap-2 justify-content-center">
                        <button 
                          title="Modificar fechas" 
                          type="button"
                          class="btn btn-primary"
                          (click)="modificarEmpleado($event, etapa.value, empleado.value, i, iEmpleado)"
                          [disabled]="!empleado.value.id"
                        >
                          <i class="pi pi-calendar vertical-align-middle"></i>
                        </button>
                        <button 
                          title="Eliminar empleado"
                          type="button"
                          class="btn btn-danger"
                          (click)="eliminarEmpleado($event, etapa.value, empleado.value, i, iEmpleado)"
                          [disabled]="!empleado.value.id"
                        >
                          <i class="pi pi-trash vertical-align-middle"></i>
                        </button>
                      </div>
                    </td>
                    <td>{{empleado.value.numempleadoRrHh}}</td>
                    <td>{{empleado.value.empleado}}</td>
                    <td *ngFor="let mesRegistro of etapa.value.meses">
                      {{empleado.value.fechas | porcentajeMes:mesRegistro}}
                    </td>
                  </tr>
              </ng-template>
            </p-table>
          </ng-template>
        </p-accordionTab>
      </p-accordion>
    </ng-container>
</ng-template>

<!-- <p>{{ form.value | json }}</p> -->






























































<!-- <ng-template #tablaEtapas2>

  <div class="add-empleadosCampos-form" [formGroup]="formEtapas">
    <ng-container formArrayName="etapasCampos">
    <p-table [tableStyle]="{ 'min-width': '50rem' }" [value]="etapasCampos.controls">
      <ng-template pTemplate="header">
        <tr>
            <th>Descripción de la etapa</th>
            <th class="text-center">Meses</th>
            <th class="text-center">Marcar por fecha</th>
            <th class="text-center">Borrar</th>
            <th 
              *ngFor="let mes of meses"
              class="text-center"
            >
              {{mes}}
            </th>
        </tr>
      </ng-template>
          <ng-template pTemplate="body" let-empleadoForm let-i="rowIndex">
            <tr [formGroupName]="i">
              <td>{{ etapasCampos.value[i].nombre }}</td>
              <td class="text-center">{{ etapasCampos.value[i].totalMeses }}</td>
              <td class="text-center">
                <p-button icon="pi pi-calendar" styleClass="p-button-rounded p-button-info" (onClick)="marcarPorFecha(i)"></p-button>
              </td>
              <td class="text-center">
                <p-button icon="pi pi-trash" styleClass="p-button-rounded p-button-danger" (onClick)="borrarEtapa(i)"></p-button>
              </td>
              <td 
                *ngFor="let mes of meses; index as iMes"
                class="text-center"
              >
                  <p-checkbox
                    formControlName="{{iMes}}" 
                    [binary]="true"
                    inputId="binary"
                    (onChange)="toggleOpcion(i, iMes)"
                  ></p-checkbox>
              </td>
            </tr>
          </ng-template>
      </p-table>
    </ng-container>
  </div>

</ng-template> -->

<!-- <hr>

<h1>Empleados</h1>

<div class="add-empleadosCampos-form" [formGroup]="form">
  <ng-container formArrayName="empleadosCampos">
  <p-table [tableStyle]="{ 'min-width': '50rem' }" [value]="empleadosCampos.controls">
    <ng-template pTemplate="header">
      <tr>
          <th>Número de empleado RRHH</th>
          <th>Nombre</th>
          <th>Posición</th>
          <th>Meses</th>
          <th>Borrar</th>
          <th *ngFor="let mes of meses">
            {{mes}}
          </th>
      </tr>
    </ng-template>
        <ng-template pTemplate="body" let-empleadoForm let-i="rowIndex">
          <tr [formGroupName]="i">
            <td>
              <a 
                class="text-success font-bold"
                [routerLink]="['/empleados/edicion-empleado', empleados[i].cod]"
              >
                {{empleados[i].cod}}
              </a>
            </td>
            <td>{{empleados[i].nombre}}</td>
            <td>{{empleados[i].posicion}}</td>
            <td>{{empleados[i].totalMeses}}</td>
            <td>
              <p-button icon="pi pi-trash" styleClass="p-button-rounded p-button-danger" (onClick)="borrarEmpleado(i)"></p-button>
            </td>
            <td *ngFor="let mes of meses; index as iMes">
              <span class="p-input-icon-right">
                <i class="pi pi-percentage"></i>
                <p-inputNumber
                  formControlName="{{iMes}}"
                  locale="es-MX" 
                  mode="decimal" 
                  [max]="100"
                  [maxFractionDigits]="2"
                  [maxlength]="3"
                  (onBlur)="sumarTotal(i, iMes, $event)"
                  class="custom-input-number"
                ></p-inputNumber>
              </span>
            </td>
          </tr>
        </ng-template>
    </p-table>
  </ng-container>
</div>

<button class="btn btn-info mt-5" (click)="modificarEmpleado()">
  Agregar empleado
</button> -->